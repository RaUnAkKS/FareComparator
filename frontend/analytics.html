<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Analytics â€” FareComparator</title>
    <link rel="stylesheet" href="analytics.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        .chart-wrapper { height: 330px; position: relative; }
        .loading-overlay {
          display: none;
          position: absolute;
          inset: 0;
          background: rgba(255,255,255,0.75);
          align-items: center;
          justify-content: center;
          font-weight: 700;
          color: #333;
          z-index: 999;
        }
    </style>
</head>

<body>
<div class="app-shell">
    <header class="app-nav">
        <div class="app-brand"><span>FareComparator</span></div>
        <nav class="app-nav-links">
            <a href="compare.html">Compare</a>
            <a href="history.html">History</a>
            <a href="analytics.html" class="active">Analytics</a>
        </nav>
    </header>

    <main class="app-main">

        <!-- SUMMARY CARD -->
        <section class="card">
            <div class="card-header">
                <div>
                    <h1 class="card-title">Analytics Summary</h1>
                    <p class="text-muted">Overview for user.</p>
                </div>
                <span class="chip">Analytics API</span>
            </div>

            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
                <div class="stat-card card">
                    <div class="text-muted">Total Requests</div>
                    <div id="totalRequests" style="font-weight:700;font-size:1.4rem">â€”</div>
                </div>
                <div class="stat-card card">
                    <div class="text-muted">Average Savings (â‚¹)</div>
                    <div id="avgSavings" style="font-weight:700;font-size:1.4rem">â€”</div>
                </div>
                <div class="stat-card card">
                    <div class="text-muted">Most Used Provider</div>
                    <div id="mostUsed" style="font-weight:700;font-size:1.2rem">â€”</div>
                </div>
            </div>
        </section>

        <!-- PROVIDER-WISE SAVINGS TREND -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Provider-wise Savings Trend</h2>
                <div style="display:flex;gap:.5rem;align-items:center">
                    <input id="analyticsUserId" value="123"
                           style="padding:.4rem;border-radius:8px;border:1px solid #eef2f6" />
                    <button id="loadAnalytics" class="btn btn-primary btn-sm">Load</button>
                </div>
            </div>

            <div style="padding:1rem" class="card chart-container">
                <div class="chart-wrapper">
                    <div class="loading-overlay" id="chartLoading">Loadingâ€¦</div>
                    <canvas id="requestsChart"></canvas>
                </div>
                <div id="noDataMessage" style="display:none;padding:1rem;color:#666;text-align:center;">
                    No analytics data available.
                </div>
            </div>
        </section>

    </main>
</div>


<script>
    const totalRequests = document.getElementById('totalRequests');
    const avgSavings = document.getElementById('avgSavings');
    const mostUsed = document.getElementById('mostUsed');

    const loadAnalytics = document.getElementById('loadAnalytics');
    const userIdInput = document.getElementById('analyticsUserId');

    const chartCanvas = document.getElementById('requestsChart');
    const chartLoading = document.getElementById('chartLoading');
    const noDataMessage = document.getElementById('noDataMessage');

    let providerChart = null;

    const COLORS = [
      "#1f77b4", "#ff7f0e", "#2ca02c",
      "#d62728", "#9467bd", "#8c564b",
      "#e377c2", "#7f7f7f", "#17becf"
    ];

    // SUMMARY DATA
    async function loadSummary(userId) {
  try {
    const res = await fetch(`/api/v1/analytics/summary?userId=${userId}`);

    if (!res.ok) {
      const errText = await res.text().catch(() => "Unable to read error body");
      console.error(`Summary API Error: HTTP ${res.status} - ${errText}`);
      throw new Error(`Summary request failed: ${res.status}`);
    }

    const data = await res.json();

    totalRequests.textContent = data.totalRequests ?? 'â€”';
    avgSavings.textContent = (data.averageSavings ?? 0).toFixed(2);
    mostUsed.textContent = data.mostUsedProvider ?? 'â€”';

  } catch (e) {
    console.error("Summary fetch error:", e);
  }
}


    // PROVIDER-WISE SAVINGS TREND
    // PROVIDER-WISE SAVINGS TREND
async function loadProviderSavings(userId) {
  chartLoading.style.display = "flex";
  noDataMessage.style.display = "none";

  try {
    const res = await fetch(`/api/v1/analytics/provider-savings-trend?userId=${userId}`);

    // ðŸ”¥ HTTP STATUS CHECK (CodeRabbit requirement)
    if (!res.ok) {
      console.error(`ProviderSavings API Error: HTTP ${res.status} - ${res.statusText}`);

      destroyChart();
      noDataMessage.style.display = "block";

      return; // â— Prevent parsing non-JSON error body
    }

    // âœ” Only parse JSON when response.ok = true
    const data = await res.json();

    if (!data.labels?.length || !data.datasets?.length) {
      destroyChart();
      noDataMessage.style.display = "block";
      return;
    }

    const chartData = data.datasets.map((ds, i) => {
      const color = COLORS[i % COLORS.length];
      return {
        label: ds.label,
        data: ds.data,
        tension: 0.3,
        borderWidth: 2,
        fill: false,
        borderColor: color,
        backgroundColor: color,
        pointRadius: 4,
        pointHoverRadius: 6
      };
    });

    renderProviderChart(data.labels, chartData);

  } catch (e) {
    console.error("ProviderSavings fetch error:", e);
    destroyChart();
    noDataMessage.style.display = "block";
  } finally {
    chartLoading.style.display = "none";
  }
}


    function renderProviderChart(labels, datasets) {
      if (providerChart) providerChart.destroy();

      providerChart = new Chart(chartCanvas.getContext("2d"), {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "nearest", intersect: false },
          plugins: {
            legend: {
              position: "top",
              labels: { usePointStyle: true }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: â‚¹${ctx.formattedValue}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Savings (â‚¹)" }
            },
            x: {
              title: { display: true, text: "Request Number" }
            }
          }
        }
      });
    }

    function destroyChart() {
      if (providerChart) {
        providerChart.destroy();
        providerChart = null;
      }
    }

    loadAnalytics.addEventListener("click", async () => {
      const userId = userIdInput.value.trim() || "123";
      chartLoading.style.display = "flex";
      await loadSummary(userId);
      await loadProviderSavings(userId);
      chartLoading.style.display = "none";
    });

    window.onload = () => loadAnalytics.click();
</script>

</body>
</html>

