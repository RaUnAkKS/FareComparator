<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Compare — FareComparator</title>
  <link rel="stylesheet" href="compare.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-nav">
      <div class="app-brand"><span>FareComparator</span><span class="badge"></span></div>
      <nav class="app-nav-links">
        <a href="compare.html" class="active">Compare</a>
        <a href="history.html">History</a>
        <a href="analytics.html">Analytics</a>
      </nav>
    </header>

    <main class="app-main">
      <section class="card">
        <div class="card-header">
          <div>
            <h1 class="card-title">Compare Fares</h1>
            <p class="text-muted">Enter origin & destination — results from /api/v1/compare</p>
          </div>
          <span class="chip">Compare API</span>
        </div>

        <form id="compareForm" class="form-grid form-grid-2">
          <div class="form-field">
            <label for="userId">User ID</label>
            <input id="userId" name="userId" value="123" />
          </div>
          <div class="form-field">
            <label for="preferCheapest">Prefer Cheapest?</label>
            <select id="preferCheapest" name="preferCheapest">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="form-field">
            <label for="origin">Origin</label>
            <input id="origin" name="origin" placeholder="Noida Sector 62" required />
          </div>
          <div class="form-field">
            <label for="destination">Destination</label>
            <input id="destination" name="destination" placeholder="Rajiv Chowk" required />
          </div>

          <div class="form-field">
            <label for="departureTime">Departure (optional)</label>
            <input id="departureTime" name="departureTime" type="datetime-local" />
          </div>
          <div class="form-field">
            <label>&nbsp;</label>
            <div style="display:flex; gap:.5rem;">
              <button type="submit" class="btn btn-primary">Compare</button>
              <button id="refreshBtn" type="button" class="btn btn-secondary btn-sm">Refresh</button>
              <button id="clearBtn" type="button" class="btn btn-secondary btn-sm">Clear</button>
            </div>
          </div>

          <div class="form-field" style="grid-column:1/-1">
            <div id="statusLine" class="text-muted">Idle</div>
          </div>
        </form>
      </section>

      <section class="card" id="resultsCard">
        <div class="card-header">
          <div>
            <h2 class="card-title">Providers</h2>
            <p class="text-muted" id="metaLine">No request yet</p>
          </div>
          <span class="badge" id="resultsCount">0</span>
        </div>

        <div id="providersList" class="providers-grid">
          <div class="text-muted" style="padding:1rem">No results — submit a compare request.</div>
        </div>
      </section>
    </main>
  </div>

<script>
  const API_BASE = ''; // if needed set '/api' or full origin
  const compareForm = document.getElementById('compareForm');
  const providersList = document.getElementById('providersList');
  const statusLine = document.getElementById('statusLine');
  const metaLine = document.getElementById('metaLine');
  const resultsCount = document.getElementById('resultsCount');
  const refreshBtn = document.getElementById('refreshBtn');
  const clearBtn = document.getElementById('clearBtn');

  let lastRequestPayload = null;
  let lastResponseMeta = null;

  function setStatus(text, error=false) {
    statusLine.textContent = text;
    statusLine.style.color = error ? '#dc2626' : '#6b7280';
  }

  function renderProviders(sortedFares = [], recommendedId = null) {
    providersList.innerHTML = '';
    if (!sortedFares || sortedFares.length === 0) {
      providersList.innerHTML = '<div class="text-muted" style="padding:1rem">No providers returned</div>';
      resultsCount.textContent = '0';
      return;
    }
    resultsCount.textContent = sortedFares.length;
    // Build cards
    sortedFares.forEach(p => {
      const el = document.createElement('div');
      el.className = 'provider-card' + (p.providerId === recommendedId ? ' recommended' : '');
      el.innerHTML = `
        <div class="provider-top">
          <div class="provider-name">${escapeHtml(p.providerName)}</div>
          ${p.isSurge ? '<div class="surge">Surge</div>' : ''}
        </div>
        <div class="provider-body">
          <div class="fare">₹ ${Number(p.price).toFixed(2)}</div>
          <div class="eta">ETA: ${p.etaMinutes ?? '-'}m</div>
        </div>
        <div class="provider-foot">
          <div class="small text-muted">providerId: ${escapeHtml(p.providerId)}</div>
        </div>
      `;
      providersList.appendChild(el);
    });
  }

  function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function doCompare(payload) {
    setStatus('Loading...');
    providersList.innerHTML = '<div class="text-muted" style="padding:1rem">Loading providers...</div>';
    try {
      const res = await fetch(API_BASE + '/api/v1/compare', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      // Expected response shape from spec:
      // { requestId, origin, destination, totalDistanceKm, sortedFares: [...], recommendation: {...}, meta: {...} }
      lastResponseMeta = data.meta || null;
      metaLine.textContent = `Request: ${data.requestId || '-'} • Distance: ${data.totalDistanceKm ?? '-'} km • ${lastResponseMeta ? 'traceId:' + lastResponseMeta.traceId : ''}`;
      setStatus('Loaded at ' + (lastResponseMeta?.timestamp ? new Date(lastResponseMeta.timestamp).toLocaleString() : new Date().toLocaleTimeString()));
      renderProviders(data.sortedFares || [], data.recommendation?.chosenProviderId || null);

    } catch (err) {
      console.error(err);
      setStatus('Failed to load — check console', true);
      providersList.innerHTML = '<div class="text-muted" style="padding:1rem">Error loading providers</div>';
    }
  }

  compareForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const form = new FormData(compareForm);
    const payload = {
      userId: form.get('userId') || '123',
      origin: form.get('origin'),
      destination: form.get('destination'),
      departureTime: form.get('departureTime') || null,
      preferCheapest: (form.get('preferCheapest') === 'true'),
      preferFastest: false
    };
    lastRequestPayload = payload;
    doCompare(payload);
  });

  refreshBtn.addEventListener('click', () => {
    if (!lastRequestPayload) {
      setStatus('No previous request to refresh', true);
      return;
    }
    doCompare(lastRequestPayload);
  });

  clearBtn.addEventListener('click', () => {
    compareForm.reset();
    providersList.innerHTML = '<div class="text-muted" style="padding:1rem">No results — submit a compare request.</div>';
    metaLine.textContent = 'No request yet';
    resultsCount.textContent = '0';
    setStatus('Idle');
    lastRequestPayload = null;
    lastResponseMeta = null;
  });
</script>
</body>
</html>
