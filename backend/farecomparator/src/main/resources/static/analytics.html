<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Analytics â€” FareComparator</title>
  <link rel="stylesheet" href="analytics.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <header class="app-nav">
      <div class="app-brand"><span>FareComparator</span><span class="badge"></span></div>
      <nav class="app-nav-links">
        <a href="compare.html">Compare</a>
        <a href="history.html">History</a>
        <a href="analytics.html" class="active">Analytics</a>
      </nav>
    </header>

    <main class="app-main">
      <section class="card">
        <div class="card-header">
          <div>
            <h1 class="card-title">Analytics Summary</h1>
            <p class="text-muted">Overview for user.</p>
          </div>
          <span class="chip">Analytics API</span>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
          <div class="stat-card card">
            <div class="text-muted">Total Requests</div>
            <div id="totalRequests" style="font-weight:700;font-size:1.4rem">â€”</div>
          </div>
          <div class="stat-card card">
            <div class="text-muted">Average Savings (â‚¹)</div>
            <div id="avgSavings" style="font-weight:700;font-size:1.4rem">â€”</div>
          </div>
          <div class="stat-card card">
            <div class="text-muted">Most Used Provider</div>
            <div id="mostUsed" style="font-weight:700;font-size:1.2rem">â€”</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Requests over time</h2>
          <div style="display:flex;gap:.5rem;align-items:center">
            <input id="analyticsUserId" value="123" style="padding:.4rem;border-radius:8px;border:1px solid #eef2f6" />
            <button id="loadAnalytics" class="btn btn-primary btn-sm">Load</button>
          </div>
        </div>

        <canvas id="requestsChart" height="120"></canvas>
      </section>
    </main>
  </div>

<script>
  const API_BASE = '';
  const totalRequests = document.getElementById('totalRequests');
  const avgSavings = document.getElementById('avgSavings');
  const mostUsed = document.getElementById('mostUsed');
  const loadAnalytics = document.getElementById('loadAnalytics');
  const analyticsUserId = document.getElementById('analyticsUserId');
  const requestsChartCtx = document.getElementById('requestsChart').getContext('2d');

  let chartInstance = null;

  async function loadSummary(userId){
    try {
      const res = await fetch(API_BASE + '/api/v1/analytics/summary?userId=' + encodeURIComponent(userId));
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const d = await res.json();
      totalRequests.textContent = d.totalRequests ?? 'â€”';
      avgSavings.textContent = (d.averageSavings != null) ? Number(d.averageSavings).toFixed(2) : 'â€”';
      mostUsed.textContent = d.mostUsedProvider || 'â€”';
    } catch(err){ console.error(err); }
  }
  async function loadSavingsTrend(userId) {
    try {
        const res = await fetch('/api/v1/analytics/savings-trend?userId=' + userId);
        const data = await res.json();
        renderSavingsChart(data.labels, data.savings);
    } catch (err) {
        console.error(err);
    }
}
let savingsChartInstance = null;

function renderSavingsChart(labels, values) {
    const ctx = document.getElementById('requestsChart').getContext('2d'); 
    // ðŸŸ¢ Same canvas used!

    if (savingsChartInstance) savingsChartInstance.destroy();

    savingsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Savings (â‚¹)',
                data: values,
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}


  async function loadTrends(userId){
    // If backend does not have timeseries endpoint, simulate from summary or skip.
    // Here try to call /api/v1/analytics/trends?userId=... if available, otherwise show placeholder.
    try {
      const res = await fetch(API_BASE + '/api/v1/analytics/trends?userId=' + encodeURIComponent(userId));
      if(!res.ok) {
        // fallback: show placeholder chart
        renderChart(['No Data'], [0]);
        return;
      }
      const data = await res.json();
      const labels = data.labels || [];
      const series = data.requestCountPerDay || data.tripCountPerDay || [];
      renderChart(labels, series);
    } catch(err){
      console.warn('trends failed, showing placeholder', err);
      renderChart(['No Data'], [0]);
    }
  }

  function renderChart(labels, values){
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(requestsChartCtx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Requests', data: values }]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
  }

  loadAnalytics.addEventListener('click', async () => {
    const userId = analyticsUserId.value || '123';
    await loadSummary(userId);
    await loadTrends(userId);
    await loadSavingsTrend(userId);

  });


  // initial
  loadAnalytics.click();
</script>
</body>
</html>
